# API 压力测试工具 - 腾讯云服务器部署教程

本教程将指导您如何将 API 压力测试工具部署到腾讯云服务器，包含一键部署脚本，适合新手操作。

---

## 目录

1. [准备工作](#1-准备工作)
2. [购买腾讯云服务器](#2-购买腾讯云服务器)
3. [连接服务器](#3-连接服务器)
4. [一键部署](#4-一键部署)
5. [配置数据库](#5-配置数据库)
6. [启动服务](#6-启动服务)
7. [配置域名和HTTPS（可选）](#7-配置域名和https可选)
8. [常见问题](#8-常见问题)

---

## 1. 准备工作

在开始部署之前，您需要准备以下内容：

| 准备项 | 说明 |
|--------|------|
| 腾讯云账号 | 前往 [腾讯云官网](https://cloud.tencent.com/) 注册 |
| MySQL 数据库 | 可使用腾讯云 MySQL 或自建 MySQL |
| 项目代码 | 从 GitHub 克隆或下载项目压缩包 |

---

## 2. 购买腾讯云服务器

### 2.1 登录腾讯云控制台

访问 [腾讯云控制台](https://console.cloud.tencent.com/)，使用您的账号登录。

### 2.2 购买云服务器 CVM

1. 在控制台搜索"云服务器"，点击进入
2. 点击"新建"按钮
3. 选择以下配置：

| 配置项 | 推荐选择 |
|--------|----------|
| 计费模式 | 按量计费（测试）或包年包月（生产） |
| 地域 | 选择离您最近的地域 |
| 实例类型 | 标准型 S5（2核4G 起步） |
| 操作系统 | Ubuntu 22.04 LTS 64位 |
| 系统盘 | 50GB SSD 云硬盘 |
| 公网带宽 | 按流量计费，5Mbps 起步 |

4. 设置登录密码或 SSH 密钥
5. 完成购买

### 2.3 配置安全组

购买完成后，需要开放以下端口：

| 端口 | 用途 |
|------|------|
| 22 | SSH 远程连接 |
| 80 | HTTP 访问 |
| 443 | HTTPS 访问 |
| 3000 | 应用服务端口 |

操作步骤：
1. 进入云服务器控制台
2. 点击"安全组" → "新建安全组"
3. 添加入站规则，开放上述端口
4. 将安全组绑定到您的服务器

---

## 3. 连接服务器

### 3.1 使用腾讯云 WebShell（最简单）

1. 在云服务器控制台，找到您的服务器
2. 点击"登录"按钮
3. 选择"标准登录方式"
4. 输入用户名 `ubuntu` 和密码

### 3.2 使用 SSH 客户端

**Windows 用户**：使用 [PuTTY](https://www.putty.org/) 或 Windows Terminal

**Mac/Linux 用户**：打开终端，执行：

```bash
ssh ubuntu@您的服务器公网IP
```

---

## 4. 一键部署

连接到服务器后，执行以下一键部署脚本：

### 4.1 下载并运行部署脚本

```bash
# 创建部署目录
mkdir -p ~/deploy && cd ~/deploy

# 下载一键部署脚本
cat > deploy.sh << 'EOF'
#!/bin/bash
set -e

echo "=========================================="
echo "  API 压力测试工具 - 一键部署脚本"
echo "=========================================="

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 打印带颜色的消息
info() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }

# 检查是否为 root 或有 sudo 权限
if [ "$EUID" -ne 0 ] && ! sudo -v 2>/dev/null; then
    error "请使用 root 用户或具有 sudo 权限的用户运行此脚本"
fi

# 1. 更新系统
info "正在更新系统包..."
sudo apt update && sudo apt upgrade -y

# 2. 安装 Node.js 22.x
info "正在安装 Node.js 22.x..."
if ! command -v node &> /dev/null || [[ $(node -v | cut -d'.' -f1 | tr -d 'v') -lt 22 ]]; then
    curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
    sudo apt install -y nodejs
fi
info "Node.js 版本: $(node -v)"

# 3. 安装 pnpm
info "正在安装 pnpm..."
if ! command -v pnpm &> /dev/null; then
    sudo npm install -g pnpm
fi
info "pnpm 版本: $(pnpm -v)"

# 4. 安装 PM2（进程管理器）
info "正在安装 PM2..."
if ! command -v pm2 &> /dev/null; then
    sudo npm install -g pm2
fi
info "PM2 版本: $(pm2 -v)"

# 5. 安装 Git
info "正在安装 Git..."
sudo apt install -y git

# 6. 克隆项目（如果还没有）
PROJECT_DIR="$HOME/api-stress-tester"
if [ ! -d "$PROJECT_DIR" ]; then
    info "请输入项目 Git 仓库地址（或按 Enter 跳过，稍后手动上传）："
    read -r GIT_URL
    if [ -n "$GIT_URL" ]; then
        git clone "$GIT_URL" "$PROJECT_DIR"
    else
        mkdir -p "$PROJECT_DIR"
        warn "已创建空目录，请手动上传项目文件到: $PROJECT_DIR"
    fi
else
    info "项目目录已存在: $PROJECT_DIR"
fi

# 7. 安装依赖
if [ -f "$PROJECT_DIR/package.json" ]; then
    info "正在安装项目依赖..."
    cd "$PROJECT_DIR"
    pnpm install
fi

# 8. 创建环境变量模板
info "正在创建环境变量配置文件..."
if [ ! -f "$PROJECT_DIR/.env" ]; then
    cat > "$PROJECT_DIR/.env" << 'ENVEOF'
# 数据库配置（必填）
DATABASE_URL=mysql://用户名:密码@数据库地址:3306/数据库名

# JWT 密钥（必填，请修改为随机字符串）
JWT_SECRET=your-super-secret-jwt-key-change-this

# 服务端口
PORT=3000

# 其他可选配置
NODE_ENV=production
ENVEOF
    warn "请编辑 .env 文件，填写数据库连接信息"
fi

# 9. 安装 Nginx（反向代理）
info "正在安装 Nginx..."
sudo apt install -y nginx

# 10. 配置 Nginx
info "正在配置 Nginx..."
sudo tee /etc/nginx/sites-available/api-stress-tester << 'NGINXEOF'
server {
    listen 80;
    server_name _;  # 替换为您的域名或使用 _ 表示所有

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # 增加超时时间（压测可能需要较长时间）
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
}
NGINXEOF

sudo ln -sf /etc/nginx/sites-available/api-stress-tester /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default
sudo nginx -t && sudo systemctl reload nginx

# 11. 配置防火墙
info "正在配置防火墙..."
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 3000/tcp
sudo ufw --force enable

echo ""
echo "=========================================="
echo -e "${GREEN}  部署环境准备完成！${NC}"
echo "=========================================="
echo ""
echo "后续步骤："
echo "1. 编辑环境变量: nano $PROJECT_DIR/.env"
echo "2. 构建项目: cd $PROJECT_DIR && pnpm build"
echo "3. 推送数据库: cd $PROJECT_DIR && pnpm db:push"
echo "4. 启动服务: pm2 start dist/index.js --name api-stress-tester"
echo "5. 设置开机自启: pm2 save && pm2 startup"
echo ""
echo "访问地址: http://您的服务器公网IP"
echo ""
EOF

# 添加执行权限并运行
chmod +x deploy.sh
./deploy.sh
```

### 4.2 上传项目代码

如果您没有 Git 仓库，可以使用 SCP 或 SFTP 上传项目：

**使用 SCP（命令行）**：
```bash
# 在本地电脑执行，将项目压缩包上传到服务器
scp -r ./api-stress-tester ubuntu@您的服务器IP:~/
```

**使用 SFTP 工具**：
- Windows：使用 [WinSCP](https://winscp.net/) 或 [FileZilla](https://filezilla-project.org/)
- Mac：使用 [Cyberduck](https://cyberduck.io/) 或 FileZilla

---

## 5. 配置数据库

### 5.1 使用腾讯云 MySQL（推荐）

1. 在腾讯云控制台搜索"云数据库 MySQL"
2. 购买 MySQL 实例（基础版即可）
3. 创建数据库和用户
4. 获取内网连接地址

### 5.2 自建 MySQL

在服务器上安装 MySQL：

```bash
# 安装 MySQL
sudo apt install -y mysql-server

# 安全配置
sudo mysql_secure_installation

# 创建数据库和用户
sudo mysql -u root -p << 'SQL'
CREATE DATABASE api_stress_tester CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'stress_user'@'localhost' IDENTIFIED BY '您的密码';
GRANT ALL PRIVILEGES ON api_stress_tester.* TO 'stress_user'@'localhost';
FLUSH PRIVILEGES;
SQL
```

### 5.3 配置环境变量

编辑 `.env` 文件：

```bash
cd ~/api-stress-tester
nano .env
```

填写数据库连接信息：

```env
DATABASE_URL=mysql://stress_user:您的密码@localhost:3306/api_stress_tester
JWT_SECRET=请替换为一个随机的长字符串
PORT=3000
NODE_ENV=production
```

保存并退出（Ctrl+X，然后按 Y，再按 Enter）

---

## 6. 启动服务

### 6.1 构建项目

```bash
cd ~/api-stress-tester

# 安装依赖
pnpm install

# 构建生产版本
pnpm build

# 推送数据库结构
pnpm db:push
```

### 6.2 使用 PM2 启动

```bash
# 启动服务
pm2 start dist/index.js --name api-stress-tester

# 查看运行状态
pm2 status

# 查看日志
pm2 logs api-stress-tester

# 设置开机自启
pm2 save
pm2 startup
# 执行上面命令输出的 sudo 命令
```

### 6.3 验证部署

打开浏览器，访问：`http://您的服务器公网IP`

如果看到 API 压力测试工具界面，说明部署成功！

---

## 7. 配置域名和HTTPS（可选）

### 7.1 绑定域名

1. 在域名服务商处添加 A 记录，指向服务器 IP
2. 修改 Nginx 配置：

```bash
sudo nano /etc/nginx/sites-available/api-stress-tester
```

将 `server_name _;` 改为 `server_name 您的域名;`

```bash
sudo nginx -t && sudo systemctl reload nginx
```

### 7.2 配置 HTTPS（Let's Encrypt 免费证书）

```bash
# 安装 Certbot
sudo apt install -y certbot python3-certbot-nginx

# 申请证书（替换为您的域名和邮箱）
sudo certbot --nginx -d 您的域名 --email 您的邮箱 --agree-tos --non-interactive

# 设置自动续期
sudo systemctl enable certbot.timer
```

---

## 8. 常见问题

### Q1: 访问页面显示 502 Bad Gateway

**原因**：Node.js 服务未启动或端口不对

**解决方案**：
```bash
# 检查服务状态
pm2 status

# 如果服务未运行，重新启动
pm2 restart api-stress-tester

# 查看错误日志
pm2 logs api-stress-tester --err
```

### Q2: 数据库连接失败

**原因**：数据库配置错误或网络不通

**解决方案**：
```bash
# 测试数据库连接
mysql -h 数据库地址 -u 用户名 -p

# 检查 .env 文件配置
cat ~/api-stress-tester/.env
```

### Q3: 端口被占用

**解决方案**：
```bash
# 查看端口占用
sudo lsof -i :3000

# 杀死占用进程
sudo kill -9 进程ID

# 或修改 .env 中的 PORT 为其他端口
```

### Q4: 如何更新项目

```bash
cd ~/api-stress-tester

# 拉取最新代码
git pull

# 重新安装依赖
pnpm install

# 重新构建
pnpm build

# 重启服务
pm2 restart api-stress-tester
```

---

## 快速命令参考

| 操作 | 命令 |
|------|------|
| 查看服务状态 | `pm2 status` |
| 查看日志 | `pm2 logs api-stress-tester` |
| 重启服务 | `pm2 restart api-stress-tester` |
| 停止服务 | `pm2 stop api-stress-tester` |
| 重新构建 | `cd ~/api-stress-tester && pnpm build` |
| 查看 Nginx 状态 | `sudo systemctl status nginx` |
| 重载 Nginx | `sudo systemctl reload nginx` |

---

## 技术支持

如果您在部署过程中遇到问题，可以：

1. 查看项目日志：`pm2 logs api-stress-tester`
2. 查看 Nginx 日志：`sudo tail -f /var/log/nginx/error.log`
3. 在项目 GitHub 仓库提交 Issue

---

*文档版本：1.0 | 更新日期：2026-02-05 | 作者：Manus AI*
