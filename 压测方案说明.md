# API接口压力测试方案

## 一、测试目标

针对以下API接口进行压力测试：

| 项目 | 内容 |
|------|------|
| **目标URL** | `https://pqtdlrkpxk.execute-api.cn-north-1.amazonaws.com.cn/uat/v1/stations/day-power` |
| **请求方法** | POST |
| **并发限制** | 100 |
| **限流阈值** | 1000 QPS |

---

## 二、测试工具功能

### 2.1 核心功能

| 功能 | 说明 |
|------|------|
| **并发控制** | 支持1-200并发数自定义设置 |
| **QPS控制** | 支持1-2000 QPS目标设置 |
| **测试时长** | 支持按时长（5-300秒）或按总请求数测试 |
| **实时监控** | 实时显示QPS、延迟、错误率等指标 |
| **可视化图表** | 提供多种实时图表展示测试数据 |

### 2.2 监控指标

**请求统计**
- 总请求数
- 成功请求数
- 失败请求数
- 吞吐量 (req/s)

**延迟指标**
- 平均延迟
- 最小延迟
- 最大延迟
- P50/P90/P95/P99 延迟

**错误分析**
- 错误率百分比
- 状态码分布
- 错误日志详情

### 2.3 可视化图表

1. **实时QPS曲线** - 展示每秒请求数变化
2. **响应延迟曲线** - 展示延迟变化趋势
3. **错误率曲线** - 展示错误率变化
4. **状态码分布图** - 柱状图展示各状态码数量
5. **延迟分布图** - 展示P50/P90/P95/P99分布
6. **成功率饼图** - 直观展示成功/失败比例

---

## 三、压测方案

### 3.1 基准测试

**目的**：确定API在正常负载下的性能基线

| 参数 | 设置值 |
|------|--------|
| 并发数 | 10 |
| 目标QPS | 50 |
| 测试时长 | 60秒 |

**关注指标**：
- 平均响应时间
- P99响应时间
- 错误率（应为0%）

### 3.2 并发极限测试

**目的**：测试API的并发处理能力极限

| 阶段 | 并发数 | QPS | 时长 |
|------|--------|-----|------|
| 阶段1 | 50 | 200 | 30秒 |
| 阶段2 | 80 | 400 | 30秒 |
| 阶段3 | 100 | 500 | 30秒 |
| 阶段4 | 120 | 600 | 30秒 |

**关注指标**：
- 并发数达到100时的表现
- 超过100并发时的错误率变化
- 响应时间是否急剧上升

### 3.3 限流测试

**目的**：验证API的限流机制是否生效

| 阶段 | 并发数 | QPS | 时长 |
|------|--------|-----|------|
| 阶段1 | 50 | 500 | 30秒 |
| 阶段2 | 50 | 800 | 30秒 |
| 阶段3 | 50 | 1000 | 30秒 |
| 阶段4 | 50 | 1200 | 30秒 |

**关注指标**：
- QPS达到1000时是否开始限流
- 限流时返回的状态码（通常为429）
- 限流后的请求处理策略

### 3.4 持续压力测试

**目的**：测试API在持续高负载下的稳定性

| 参数 | 设置值 |
|------|--------|
| 并发数 | 80 |
| 目标QPS | 800 |
| 测试时长 | 300秒（5分钟） |

**关注指标**：
- 响应时间是否保持稳定
- 是否出现内存泄漏或性能衰减
- 错误率是否保持在可接受范围

### 3.5 峰值冲击测试

**目的**：模拟突发流量场景

| 参数 | 设置值 |
|------|--------|
| 并发数 | 100 |
| 目标QPS | 1000 |
| 测试时长 | 60秒 |

**关注指标**：
- API在峰值负载下的表现
- 是否触发熔断机制
- 恢复正常后的响应情况

---

## 四、测试结果分析

### 4.1 性能评估标准

| 指标 | 优秀 | 良好 | 需优化 |
|------|------|------|--------|
| 平均延迟 | <200ms | 200-500ms | >500ms |
| P99延迟 | <500ms | 500-1000ms | >1000ms |
| 错误率 | <0.1% | 0.1-1% | >1% |
| 吞吐量 | >800 QPS | 500-800 QPS | <500 QPS |

### 4.2 常见问题诊断

| 现象 | 可能原因 | 建议措施 |
|------|----------|----------|
| 高延迟 | 服务器处理能力不足 | 扩容或优化代码 |
| 429错误 | 触发限流 | 降低请求频率 |
| 5xx错误 | 服务器内部错误 | 检查服务器日志 |
| 连接超时 | 网络问题或服务过载 | 检查网络或增加超时时间 |

---

## 五、使用说明

### 5.1 配置参数

1. **目标URL**：输入要测试的API地址
2. **请求方法**：选择HTTP方法（GET/POST/PUT/DELETE/PATCH）
3. **并发数**：设置同时发起的请求数量
4. **目标QPS**：设置每秒请求数目标
5. **测试模式**：
   - 按时长：设置测试持续时间
   - 按请求数：设置总请求数量

### 5.2 高级配置

在"高级配置"标签页中可以设置：
- **请求头**：JSON格式的HTTP头信息
- **请求体**：JSON格式的请求数据

### 5.3 操作流程

1. 配置测试参数
2. 点击"开始测试"按钮
3. 观察实时监控数据
4. 可随时"暂停"或"停止"测试
5. 测试完成后分析结果

---

## 六、注意事项

### 6.1 浏览器限制

由于浏览器的CORS（跨域资源共享）安全策略，直接从浏览器向跨域API发送请求可能会失败。解决方案：

1. **API端配置CORS**：联系API提供方添加CORS响应头
2. **使用代理服务**：通过代理服务器转发请求
3. **后端压测**：使用服务器端压测工具

### 6.2 测试建议

1. **循序渐进**：从低负载开始，逐步增加压力
2. **监控服务端**：同时监控API服务器的资源使用情况
3. **避免生产环境**：尽量在测试环境进行压测
4. **记录基线**：每次测试前记录系统基线状态
5. **多次测试**：进行多次测试取平均值，排除偶发因素

### 6.3 结果解读

- **QPS曲线波动大**：可能存在性能瓶颈或限流
- **延迟持续上升**：服务器可能过载
- **错误率突增**：可能触发了限流或熔断
- **状态码429**：已触发API限流保护

---

## 七、工具技术架构

### 7.1 前端技术栈

- **框架**：React 19
- **样式**：Tailwind CSS 4
- **图表**：Recharts
- **UI组件**：shadcn/ui

### 7.2 压测引擎

- **并发控制**：基于Promise和async/await实现
- **QPS控制**：使用定时器精确控制请求频率
- **指标计算**：实时计算延迟百分位数
- **数据采集**：每500ms更新一次监控数据

---

## 八、附录

### 8.1 预设测试数据

**请求头**：
```json
{
  "x-api-key": "tRWNQ7sGlp76vPVLRn0tIask7bLwXW7yEMqMTTYi",
  "Content-Type": "application/json"
}
```

**请求体**：
```json
{
  "stationno": ["105H2404000686", "105H2404000648", ...],
  "dateRange": ["2025-11-01", "2025-11-02", ...]
}
```

### 8.2 性能指标说明

| 指标 | 说明 |
|------|------|
| QPS | Queries Per Second，每秒查询数 |
| P50 | 50%的请求延迟低于此值 |
| P90 | 90%的请求延迟低于此值 |
| P95 | 95%的请求延迟低于此值 |
| P99 | 99%的请求延迟低于此值 |
| 吞吐量 | 单位时间内完成的请求数 |
| 错误率 | 失败请求占总请求的百分比 |
